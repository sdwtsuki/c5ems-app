<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>Hello MUI</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" href="../css/mui.min.css">
		<link id="style_set" rel="stylesheet" href="../css/style_medium.css">
		<link rel="stylesheet" type="text/css" href="../css/feedback.css" />
		
		<script type="text/javascript">
			var style_set = document.getElementById("style_set");
			style_set.setAttribute("href","../css/"+ localStorage.getItem('styleSize') +".css");
		</script>
	</head>

	<body id="Page_setting" class="mui-fullscreen">
		<!--页面主结构开始-->
		<div id="app" class="mui-views">
			<div class="mui-view">
				<div class="mui-navbar">
				</div>
				<div class="mui-pages">
				</div>
			</div>
		</div>
		<!--页面主结构结束-->
		<!--单页面开始-->
		<div id="setting" class="mui-page">
			<!--页面标题栏开始-->
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<h1 class="mui-center mui-title titletext">设置</h1>
			</div>
			<!--页面标题栏结束-->
			<!--页面主内容区开始-->
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<ul class="mui-table-view mui-table-view-chevron">
							<li class="mui-table-view-cell liheight" >
								<a id="opensetting_user" class="mui-navigate-right" href="#">
									<img class="mui-media-object mui-pull-left head-img mt5px" id="head-img" src="../APP ICO.png">
									<div class="" >
										<div id = "setting_username" class="commontext mb7px" ></div>
										<p class="marktext" >C5-EMS 能源监控管理平台</p>
									</div>
								</a>
							</li>
						</ul>
						
						<ul class="mui-table-view mui-table-view-chevron">
							<li class="mui-table-view-cell commontext liheight">
								异常颜色
								<input id="alarm_color" type="color" class="mui-btn" value="#FF0000" />
							</li>
							<li class="mui-table-view-cell commontext liheight" >
								<a href="#privacy" >自动登录</a>
								<div id="autologin" class="mui-switch mui-active">
									<div class="mui-switch-handle"></div>
								</div>
							</li>
							
							<li class="mui-table-view-cell commontext liheight" >
								<a id="a_style_select" class="mui-navigate-right " href="#">
									字体大小
										<select id="style_select" size="1" class="commontext">
										  <option id="radio_big" value ="style_big">大</option>
										  <option id="radio_medium" value ="style_medium">中</option>
										  <option id="radio_small" value="style_small" selected="selected">小</option>
										</select>
								</a>
							</li>
						
							<!--<li class="mui-table-view-cell commontext liheight" >
								<a href="#privacy" >后台通知</a>
								<div id="back_end_notify" class="mui-switch mui-active">
									<div class="mui-switch-handle"></div>
								</div>
							</li>-->
							
						
							<li class="mui-table-view-cell commontext liheight" >
								<a href="#about" class="mui-navigate-right">关于 C5-EMS <i id="app_version" class="mui-pull-right update marktext">V3.6.1</i></a>
							</li>
						</ul>
						<ul class="mui-table-view">
							<li class="mui-table-view-cell" >
								<div >
									<button type="button" class="mui-btn mui-btn-success commontext btnheight" data-loading-text = "提交中" data-loading-icon-position="right" style="float:left;width: 48%;" onclick="loginEsc()">清空缓存</button>
									<button type="button" class="mui-btn mui-btn-danger commontext btnheight" data-loading-text = "提交中" data-loading-icon-position="right" style="float:left;width: 48%;margin-left: 4%;" onclick="Esc()">退出</button>
								</div>
							</li>
							
						</ul>
					</div>
				</div>				
			</div>
			<!--页面主内容区结束-->
		</div>
		<!--单页面结束-->
		<div id="alluserpage" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>设置
				</button>
				<h1 class="mui-center mui-title">用户</h1>
			</div>
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<div style="margin-top: 10%;">
					    	<div id="" class="commontext mgn10pct" >
					    		新账号登录:
					    	</div>
					    	
							<form id='login-form' class="mui-input-group mgn10pct" >
								<div class="mui-input-row">
									<label class="commontext">账号</label>
									<input id='account' type="text" class="mui-input-clear mui-input" placeholder="请输入账号">
								</div>
								<div class="mui-input-row">
									<label class="commontext">密码</label>
									<input id='password' type="password" class="mui-input-clear mui-input" placeholder="请输入密码">
								</div>
							</form>
					    	<button type="button" id='sub' style="width: 80%;" class="mui-btn mui-btn-primary commontext btnheight btnheight mgn10pct" data-loading-text = "提交中" data-loading-icon-position="right" >确定</button>
					    </div>
					    
					    <ul id="userlist_ul" class="mui-table-view mui-table-view-chevron mgn10pct" >
					    	<!--<li id="userlist" class="userlist mui-table-view-cell commontext liheight" style="text-align: left;">
					    		
							</li>-->
						</ul>
					</div>
				</div>
			</div>
		</div>
		
		
		
		<div id="about" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>设置
				</button>
				<h1 class="mui-center mui-title titletext"></h1>
			</div>
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<div id="touxiang" >
								<img  src="../APP ICO.png" />
							</div>
						<ul class="mui-table-view">
							
							<li class="mui-table-view-cell commontext liheight">
								<a id="feedback-btn" href="#feedback" class="mui-navigate-right ">功能介绍</a>
							</li>
							<li class="mui-table-view-cell commontext liheight">
								<a id="feedback-btn" href="#feedback1" class="mui-navigate-right ">更新历史</a>
							</li>
							<li id="check_update" class="mui-table-view-cell mui-plus-visible commontext liheight">
								<a id="update" class="">检查更新 <i id="update_percent" class="mui-pull-right update"></i>
							</li>
						</ul>
					</div>
				</div>
			</div>
		</div>

		<div id="feedback" class="mui-page feedback">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>
				</button>
				
				<h1 class="mui-center mui-title titletext">功能介绍</h1>
			</div>
			<div id="introduce">
				<h4 >
					C5-EMS能源管理系统APP
				</h4>
				<p>
					主要功能：
				</p>
				<p>1.登录权限</p>
				<p>
					系统采用无级别权限设计，可针对任何用户设定可查看区域，可查看设备，可使用功能模块，同时内置3种默认权限模块（管理员，班组长，用户）方便用户使用。
				</p>	
				<p>2.实时数据</p>
				<p>
					APP可实时对接能耗管理相关仪表（水表，电表，空调表，蒸汽表），并在手机上实时展示对应表具相关数据（包括实时水量，电表，电压，电流，温度，压力，瞬时流量等数据），并可接入任何开放通讯协议的智能仪表。
				</p>
				<p>3.设备控制</p>
				<p>
					在权限允许条件下，用户可使用 APP 实时在线对相关设备进行强制开启，断电，上电等远程控制操作，并实时反馈操作结果。
				</p>
				<p>4.在线充值</p>
				<p>
					得益于移动支付的广泛应用，APP 已经集成在线支付功能（包括微信，支付宝的内购以及扫码支付），可以更好的为欠费关断，充值开通等管理需求提供支持。
				</p>
				<p>5.异常报警</p>
				<p>
					作为能耗管理当中非常重要的一部分，异常报警不仅仅只能在管理机房展现，在手机APP中提供实时异常报警是我们努力人性化能耗管理系统中很重要的一步。APP可实时推送通讯异常，数据异常，输入及输出等各类状态异常。
				</p>
				<p>6.数据报表</p>
				<p>
					作为精细化管理的一部分，数据报表也完整的移植到APP上，包括日明细，时段明细。
				</p>
				<p>7.统计分析</p>
				<p>
					APP提供基于条件面板的数据统计分析功能。统计分析结果可以数据表格，曲线，棒图等多种形态展现。条件选择面板则包括统计区域选择，统计时段选择。
				</p>	
			</div>
		</div>
		
		<div id="feedback1" class="mui-page feedback">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>
				</button>
				
				<h1 class="mui-center mui-title titletext">更新历史</h1>
			</div>
			<div id="updateHistory">
			
					<!--<div class="updatehistory_title" style="">
						2017.07.02
					</div>
					<div class="updatehistory_content" style="">
						<li>
							1.增加能耗排行功能
						</li>
						<li>
							2.完善登录界面
						</li>
					</div>-->
					
			</div>
		</div>
		
		
		

	</body>
	<script src="../js/mui.min.js "></script>
	<script src="../js/mui.view.js "></script>
	<script src='../js/feedback.js'></script>
	<script>
		mui.init();
		
		//初始化单页view
		var viewApi = mui('#app').view({
			defaultPage: '#setting'
		});
		//初始化单页的区域滚动
		mui('.mui-scroll-wrapper').scroll();
		
		
				
		//检查更新
		document.getElementById("update").addEventListener('tap', function() {
			var server = "http://139.196.53.2/changhai/app_ver.php"; //获取升级描述文件服务器地址
			//plus.runtime.getProperty(plus.runtime.appid, function(wgtInfo) {
			//	t_ver = wgtInfo.version;
			//});
			mui.getJSON(server, {
				"action" : "getnewver",
				"appid": plus.runtime.appid,
				"ver": plus.runtime.version, //"2017-07-21",
				"imei": plus.device.imei,
				"imsi": plus.device.imsi,
				"model": plus.device.model,
				"vendor": plus.device.vendor,
				"username": plus.storage.getItem("g_user")
			}, function(data) {
				if (data.status=="1") {
					plus.ui.confirm(data.note, function(i) {
						if (0 == i.index) {
							t_url = "http://139.196.53.2/changhai/app_update/c5ems."+data.appver+".apk";
							//plus.runtime.openURL(t_url);
							downAPK(t_url,data.appsize);
						}
					}, data.title, ["立即更新", "取　　消"]);
				} else {
					mui.toast('当前程序已是最新版本~')
				}
			});
		});
		
	    //休眠方法
	    function sleep(numberMillis) {
	        var now = new Date();
	        var exitTime = now.getTime() + numberMillis;
	        while (true) {
	            now = new Date();
	            if (now.getTime() > exitTime)
	                return;
	        }
	    }
		
		function downAPK(fileurl,c5appfilesize){
		    var t_wait = plus.nativeUI.showWaiting("下载 C5-EMS APP 新版本...");
		    var dtask = plus.downloader.createDownload( fileurl, "", function(d,status){
		        if ( status == 200 ) { 
		        	clearInterval(i);
		        	sleep(1000);
		            console.log("下载C5-EMS成功："+d.filename);
		            installWgt(d.filename); // 安装wgt包
		        } else {
		            console.log("下载C5-EMS失败！");
		            plus.nativeUI.alert("下载C5-EMS失败！");
		        }
		        plus.nativeUI.closeWaiting();
		    });
		    
		    dtask.start();
		    
	        var i = setInterval(function(t_wait) {
	            var totalSize = dtask.totalSize;
	            var downloadedSize = dtask.downloadedSize;
	            //$('#proDownFile').attr('value', downloadedSize);
	            //$('#proDownFile').attr('max', totalSize);
	            //console.log("Now:"+dtask.downloadedSize + " Total:" + dtask.totalSize);
	            var t_Percent = Math.round(dtask.downloadedSize * 100 / c5appfilesize) + "%";
	            console.log("Now:"+dtask.downloadedSize + " Total:" + c5appfilesize + " Percent:" + t_Percent);
				document.getElementById("update_percent").innerHTML = t_Percent;
	            sleep(100);
	        }, 500); //1000为1秒钟
                                
		}

		// 更新应用资源
		function installWgt(path){
		    plus.nativeUI.showWaiting("安装C5-EMS文件...");
		    plus.runtime.install(path,{},function(){
		        plus.nativeUI.closeWaiting();
		        console.log("安装C5-EMS文件成功！");
		        plus.nativeUI.alert("C5-EMS 应用更新完成！",function(){
		            plus.runtime.restart();
		        });
		    },function(e){
		        plus.nativeUI.closeWaiting();
		        console.log("安装C5-EMS文件失败["+e.code+"]："+e.message);
		        plus.nativeUI.alert("安装C5-EMS文件失败["+e.code+"]："+e.message);
		    });
		}
		
		//更改字体默认选中
		if(localStorage.getItem("styleSize")!= null){
			switch(localStorage.getItem("styleSize")){
					case "style_small" :
					document.getElementById("radio_small").setAttribute("selected","selected");
					break;
					
					case "style_medium" :
					document.getElementById("radio_medium").setAttribute("selected","selected");
					break;
					
					case "style_big" :
					document.getElementById("radio_big").setAttribute("selected","selected");
					break;
				}
		}
		//更改异常颜色默认选中
		if(localStorage.getItem("alarm_color")!=null){
			document.getElementById("alarm_color").value = localStorage.getItem("alarm_color");
		}

		var loginEsc = function(){
			
			plus.cache.calculate(function(size) {
            //console.log(size)
            sizeCache = size;
            mui.confirm("您目前的系统缓存为" + parseFloat(sizeCache / (1024)).toFixed(2) + "K？", "清除缓存", ["确认", "取消"], function(e) {
	                if(e.index == 1) {} else {
	                    plus.cache.clear(function() {
	                        alert("缓存清除完毕")
	                    });
	                }
            	});
        	});
        	
		}
		
		var Esc = function(){
				var btn = ["确定","取消"];
				mui.confirm('确认关闭程序？','退出',btn,function(e){
					if(e.index==0){
						//mui.currentWebview.close();
						plus.runtime.quit();
					}
				});
		}
		
		var view = viewApi.view;
		(function($) {
			//处理view的后退与webview后退
			var oldBack = $.back;
			$.back = function() {
				if (viewApi.canBack()) { //如果view可以后退，则执行view的后退
					viewApi.back();
				} else { //执行webview后退
					oldBack();
				}
			};
			
			
			//ajax  更新历史 后台获取
			mui.plusReady(function () {
			var network = true;
			function getList()
			{
				if(network){
					ajax();
				}else{
					mui.toast("当前网络不给力，请稍后再试");
				}
			}
			
			//从c5_device获得数据并添加devicelist
			var ajax = function() {
				
				var t_preuri = plus.storage.getItem("g_preuri");	
				var url = t_preuri + "app_ver.php";  //测试服务器地址
				var t_user = plus.storage.getItem("g_user");
				
				var data = {
					action : "getverlist",
					user : t_user
				}; 
			//	respnoseEl.innerHTML = '正在请求中...';
				$.post(url, data, success, 'json');
			};

			var list = document.getElementById("list");
			//成功响应的回调函数
			var success = function(response) {
				
				var str = JSON.stringify(response);
				console.log(str);
				

				var updateHistory = document.getElementById("updateHistory");
			//	respnoseEl.innerHTML = "总记录：" + response.count; 
				mui.each(response, function(key, elem) {
					var div1 = document.createElement("div");
					div1.className = "updatehistory_title mb7px";
					div1.innerHTML = response[key].title;
					updateHistory.appendChild(div1);

					var div2 = document.createElement("div");
					div2.className = "updatehistory_content mb7px";
					updateHistory.appendChild(div2);
					
					for(i=0;i<response[key].data.length;i++){
						var li = document.createElement("li");
						li.innerHTML = response[key].data[i];
						div2.appendChild(li);
					}
					//console.log();
					
					    
				});
			};
			
			getList();
			});
		})(mui);
		
		
		

		if(mui.os.stream){
			document.getElementById("check_update").display = "none";
		}
		
	</script>
	
	<script type="text/javascript">
		mui.plusReady(function(){

			//setting页添加当前登录用户名
			var s_user = plus.storage.getItem("g_user");
			var user = document.getElementById("setting_username");
			user.innerHTML = '当前登录：' + s_user;
			
			// 获取本地应用资源版本号 
    		plus.runtime.getProperty(plus.runtime.appid,function(inf){ 
	        	wgtVer=inf.version; 
	        	console.log("当前应用版本："+wgtVer);
	        	var app_version = document.getElementById("app_version");
	        	app_version.innerHTML = wgtVer;
	        	app_version.className = "mui-pull-right update marktext";
	        	
	        	
    		});
		});
		
		
		
		

		
		//选择styleSize
		document.getElementById("style_select").addEventListener('input',function(){
			var styleSize = this.value;
			localStorage.setItem("styleSize",styleSize);
			
			alert("字体设置成功！系统将返回主界面生效！");
			
			//刷新底部导航栏
			mui.plusReady(function () {
				var indexPage = plus.webview.getWebviewById("index.html");
				switch(localStorage.getItem("styleSize")){
					case "style_big" : 
						indexPage.evalJS('document.getElementById("main_text").style.fontSize = "18px"');
						indexPage.evalJS('document.getElementById("device_text").style.fontSize = "18px"');
						indexPage.evalJS('document.getElementById("tongji_text").style.fontSize = "18px"');
						indexPage.evalJS('document.getElementById("rank_text").style.fontSize = "18px"');
					break;
					case "style_medium" : 
						indexPage.evalJS('document.getElementById("main_text").style.fontSize = "14px"');
						indexPage.evalJS('document.getElementById("device_text").style.fontSize = "14px"');
						indexPage.evalJS('document.getElementById("tongji_text").style.fontSize = "14px"');
						indexPage.evalJS('document.getElementById("rank_text").style.fontSize = "14px"');
					break;
					case "style_small" : 
						indexPage.evalJS('document.getElementById("main_text").style.fontSize = "12px"');
						indexPage.evalJS('document.getElementById("device_text").style.fontSize = "12px"');
						indexPage.evalJS('document.getElementById("tongji_text").style.fontSize = "12px"');
						indexPage.evalJS('document.getElementById("rank_text").style.fontSize = "12px"');
					break;
				}
				
			});
			
			//
			//var wvs = plus.webview.all();
			//plus.webview.getWebviewById(id).reload();
			var Page = plus.webview.getWebviewById('setting.html');
			mui.plusReady(function(){
				//var curr = plus.webview.getWebviewById("index.html");
				var wvs = plus.webview.all();
				for (var i = 0, len = wvs.length; i < len; i++) {
					//console.log(wvs[i].id);
					//重载除setting页面和本页面外的其他页面
					//if (wvs[i].getURL() == Page.getURL())
					//continue;
					//if (wvs[i].getURL() == curr.getURL())
					//continue;	
					plus.webview.getWebviewById(wvs[i].id).reload();
				}
			})
			
			//console.log(localStorage.getItem("styleSize"));
		});
		

		//选择alarmColor
		document.getElementById("alarm_color").addEventListener('input',function(){
			localStorage.setItem("alarm_color",this.value);
			console.log("当前异常颜色："+localStorage.getItem("alarm_color"));
		});
		
		//显示autologin按钮当前状态
		if(localStorage.getItem("autologinButtonStatus")!= null){
			if(localStorage.getItem("autologinButtonStatus") == 'false'){
				document.getElementById("autologin").className = "mui-switch";
				localStorage.setItem("autologin_status",'false');
			}else{
				var autologinButtonStatus = localStorage.getItem("autologinButtonStatus");
				localStorage.setItem("autologin_status",'true');
			}
		}else{
			var autologinButtonStatus = 'true';//标志按钮最后状态
			
		}
		//对'自动登录'按钮进行监听
	    document.getElementById("autologin").addEventListener('toggle', function(event) {
	        autologinButtonStatus=!autologinButtonStatus;
	        localStorage.setItem("autologinButtonStatus",autologinButtonStatus);
	        if(localStorage.getItem("autologinButtonStatus") == 'true'){
	        	localStorage.setItem("autologin_status",'true');
	        }else if(localStorage.getItem("autologinButtonStatus") == 'false'){
	        	localStorage.setItem("autologin_status",'false');
	        }
	    });
		
		
		
		/* 后台通知暂缓
		//显示back_end_notify按钮当前状态
		if(localStorage.getItem("notifyButtonStatus")!= null){
			if(localStorage.getItem("notifyButtonStatus") == 'false'){
				document.getElementById("back_end_notify").className = "mui-switch";
			}else{
				var notifyButtonStatus = localStorage.getItem("notifyButtonStatus");
			}
		}else{
			var notifyButtonStatus = 'true';//标志按钮最后状态
		}
		//对'后台通知'按钮进行监听
	    document.getElementById("back_end_notify").addEventListener('toggle', function(event) {
	        notifyButtonStatus=!notifyButtonStatus;
	        localStorage.setItem("notifyButtonStatus",notifyButtonStatus);
	        
	        console.log("notifyButton is :"+localStorage.getItem("notifyButtonStatus"));
	    });
		*/
		
		mui('#Page_setting').on('tap', '#opensetting_user', function(e) {
			mui.openWindow({
				  		url:'setting_user.html',
				    	id:'setting_user.html' ,
				    	styles:{
			    			top:'0px',//新页面顶部位置  
				    		bottom:'51px',//新页面底部位置  
			    		},
					    show:{
					      	autoShow:true,//页面loaded事件发生后自动显示，默认为true
					      	aniShow:"slide-in-right",//页面显示动画，默认为”slide-in-right“；
				      		duration:300//页面动画持续时间，Android平台默认100毫秒，iOS平台默认200毫秒；
					    }
				  	});
		});
		
	</script>
	
	
</html>